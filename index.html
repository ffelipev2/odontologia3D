<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Universidad San Sebastián - Visor 3D</title>
  <link rel="icon" href="data:," />
  <style>
    html, body { height: 100%; margin: 0; }
    body { background: #0b1020; color: #fff; font-family: system-ui, sans-serif; overflow: hidden; }
    header { text-align: center; padding: 10px 0; background: #111830; font-size: 20px; font-weight: 600; letter-spacing: 0.5px; color: #ffffff; box-shadow: 0 2px 6px rgba(0,0,0,.4); position: fixed; top: 0; left: 0; width: 100%; z-index: 5; }
    #progress { position: fixed; left: 50%; top: 70px; transform: translateX(-50%); background: rgba(0,0,0,.4); padding: 8px 12px; border-radius: 999px; font-size: 14px; backdrop-filter: blur(6px); box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    #credit { position: fixed; right: 14px; bottom: 12px; opacity: .7; font-size: 12px; }
    canvas { display: block; width: 100vw; height: 100vh; }

    /* Menú flotante responsive */
    #menuToggle {
      position: fixed;
      top: 80px;
      left: 12px;
      background: rgba(0,0,0,0.7);
      border: none;
      color: #fff;
      font-size: 22px;
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      z-index: 10;
    }

    #ui {
      position: fixed;
      left: 12px;
      top: 130px;
      z-index: 9;
      display: none;
    }

    .menu { background: rgba(0,0,0,.85); padding: 12px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,.35); backdrop-filter: blur(6px); width: 220px; }
    .menu h1 { margin: 0 0 8px; font-size: 16px; font-weight: 600; opacity: .9; }
    .menu button { display: block; width: 100%; margin: 6px 0; padding: 10px 12px; border: 0; border-radius: 12px; font-weight: 600; cursor: pointer; background: #ffffff; color:#111; }
    .menu button.secondary { background: #e5e7eb; }
    .menu hr{border:0;border-top:1px solid rgba(255,255,255,.15);margin:8px 0}

    @media (min-width: 768px) {
      #menuToggle { display: none; }
      #ui { display: block !important; }
    }
  </style>
</head>
<body>
  <header>Universidad San Sebastián</header>

  <button id="menuToggle">☰</button>

  <div id="ui">
    <div class="menu">
      <h1>Modelos 3D</h1>
      <button id="btn-skull">Cráneo (STL)</button>
      <button id="btn-jaw">Mandíbula (OBJ)</button>
      <hr/>
      <button id="btn-reset" class="secondary">Recentrar vista</button>
    </div>
  </div>
  <div id="progress">Cargando… <span id="pct">0%</span></div>
  <div id="credit">Arrastra para rotar · Pincha para zoom · Dos dedos para mover</div>
  <canvas id="c"></canvas>

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { STLLoader } from 'three/addons/loaders/STLLoader.js';
    import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';

    const canvas = document.getElementById('c');
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
    renderer.setPixelRatio(Math.min(2, window.devicePixelRatio));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0b1020);

    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.01, 1000);
    camera.position.set(0.8, 0.5, 1.2);

    const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
    hemi.position.set(0, 1, 0);
    scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xffffff, 1.0);
    dir.position.set(3, 5, 2);
    scene.add(dir);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.06;
    controls.enablePan = true;

    const pct = document.getElementById('pct');
    const progress = document.getElementById('progress');
    const manager = new THREE.LoadingManager();
    manager.onProgress = (_url, loaded, total) => pct.textContent = `${Math.round((loaded / total) * 100)}%`;
    manager.onLoad = () => progress.style.display = 'none';

    const boneMaterial = new THREE.MeshStandardMaterial({
      color: 0xe8e3d8,
      roughness: 0.85,
      metalness: 0.0,
      flatShading: false
    });

    let currentObject = null;

    function clearCurrent() {
      if (currentObject) {
        currentObject.traverse?.(o => { if (o.isMesh) { o.geometry?.dispose?.(); o.material?.dispose?.(); } });
        scene.remove(currentObject);
        currentObject = null;
      }
    }

    function fitCameraToObject(obj, targetRadius = 0.5) {
      const box = new THREE.Box3().setFromObject(obj);
      const size = new THREE.Vector3(); box.getSize(size);
      const center = new THREE.Vector3(); box.getCenter(center);
      obj.position.sub(center);
      const radius = Math.max(size.x, size.y, size.z) * 0.5;
      const fov = THREE.MathUtils.degToRad(camera.fov);
      const dist = (targetRadius / Math.sin(fov / 2));
      camera.position.set(dist * 1.2, dist * 0.8, dist * 1.2);
      controls.target.set(0, 0, 0);
      controls.update();
      const s = (targetRadius / (radius || 1));
      obj.scale.setScalar(s);
    }

    const stlLoader = new STLLoader(manager);
    const objLoader = new OBJLoader(manager);

    function loadSkull() {
      clearCurrent();
      stlLoader.load('./modelos/Skull.stl', geometry => {
        const material = boneMaterial.clone();
        material.color.set(0xded9cf);
        const mesh = new THREE.Mesh(geometry, material);
        mesh.castShadow = true; mesh.receiveShadow = true;
        currentObject = mesh; scene.add(mesh);
        geometry.computeBoundingBox(); geometry.center(); geometry.computeBoundingSphere();
        fitCameraToObject(mesh, 0.55);
      }, undefined, err => { console.error(err); progress.textContent = 'Error cargando Skull.stl'; });
    }

    function loadJaw() {
      clearCurrent();
      objLoader.load('./modelos/Yorik_Jaw.obj', obj => {
        obj.traverse(n => { if (n.isMesh) { n.material = boneMaterial.clone(); n.castShadow = true; n.receiveShadow = true; } });
        currentObject = obj; scene.add(obj);
        fitCameraToObject(obj, 1.8);
      }, undefined, err => { console.error(err); progress.textContent = 'Error cargando Yorik_Jaw.obj'; });
    }

    document.getElementById('btn-skull').addEventListener('click', loadSkull);
    document.getElementById('btn-jaw').addEventListener('click', loadJaw);
    document.getElementById('btn-reset').addEventListener('click', () => controls.reset());

    // Mostrar mandíbula primero
    loadJaw();

    // Toggle del menú móvil
    const menuToggle = document.getElementById('menuToggle');
    const ui = document.getElementById('ui');
    menuToggle.addEventListener('click', () => {
      ui.style.display = ui.style.display === 'block' ? 'none' : 'block';
    });

    window.addEventListener('resize', () => {
      const w = innerWidth, h = innerHeight;
      renderer.setSize(w, h);
      camera.aspect = w / h; camera.updateProjectionMatrix();
    });

    (function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    })();
  </script>
</body>
</html>
